

# â° Scheduled Tasks & WMI Persistence (Deep Fundamentals)

---

## ğŸ”¹ What (Scheduled Tasks)

**Scheduled Tasks** allow programs or scripts to run automatically based on:

* Time
* System events
* User logon
* System startup

They are designed for:

* System maintenance
* Updates
* Admin automation

Attackers use them heavily for **stealthy, reliable persistence**.

---

## ğŸ”¹ Where to check

* Task Scheduler (GUI)
* Task XML files on disk
* Security Event Logs
* Task Scheduler Operational logs
* WMI subscriptions
* EDR persistence alerts

---

## ğŸ”¹ How to check

### Windows (Built-in)

GUI

* Task Scheduler â†’ Task Scheduler Library

Command line

```cmd
schtasks /query /fo LIST /v
```

PowerShell

```powershell
Get-ScheduledTask
```

---

## ğŸ”¹ Task components (must understand)

Every scheduled task has:

### ğŸ”¸ Trigger (WHEN it runs)

* At logon
* At startup
* On schedule (daily, hourly)
* On event (Event ID based)

### ğŸ”¸ Action (WHAT it runs)

* Executable
* Script
* PowerShell
* Command line

### ğŸ”¸ Context (HOW it runs)

* User account
* SYSTEM
* Highest privileges
* Hidden or visible

---

## ğŸ”¹ Why SOC checks scheduled tasks

* Tasks survive reboot
* Can run as **SYSTEM**
* Easy to hide among legitimate tasks
* Often overlooked by analysts
* Can trigger without user interaction

Many malware families use **only scheduled tasks** for persistence.

---

## ğŸ”¹ Where tasks are stored (VERY IMPORTANT)

### On disk

```
C:\Windows\System32\Tasks\
```

(Each task is an XML file)

### Registry references

```
HKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks
HKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree
```

---

## ğŸ”¹ Where tasks are logged

### Security Log

**Event ID 4698** â€“ Task created
**Event ID 4699** â€“ Task deleted
**Event ID 4700** â€“ Task enabled
**Event ID 4702** â€“ Task updated

Example

```
A scheduled task was created
Task Name: \WindowsUpdateCheck
Action: C:\Users\user\AppData\update.exe
```

### Task Scheduler Operational Log

```
Microsoft-Windows-TaskScheduler/Operational
```

---

## ğŸ”¹ Common attacker abuse patterns

* Task names mimicking Windows or updates
* Actions pointing to:

  * `AppData`
  * `Temp`
  * User-writable paths
* Triggers set to:

  * At logon
  * Every 5â€“10 minutes
* Hidden tasks
* Tasks running as SYSTEM

---

## ğŸ”¹ Real malware scheduled task examples

### Example 1: Fake update task

```
Task Name: WindowsUpdateMonitor
Trigger: At logon
Action: C:\ProgramData\update.exe
Run as: SYSTEM
```

### Example 2: PowerShell persistence

```
Action: powershell.exe -EncodedCommand <base64>
Trigger: Every 15 minutes
```

### Example 3: Event-based trigger

```
Trigger: On Event ID 4624 (logon)
```

Used to launch malware only when a user logs in.

---

## ğŸ”¹ WMI Persistence (Advanced but critical)

### ğŸ”¸ What

WMI (Windows Management Instrumentation) allows:

* Event-based automation
* System monitoring

Attackers abuse WMI to:

* Execute payloads when specific events occur
* Avoid scheduled task visibility

This is **fileless persistence**.

---

### ğŸ”¸ Where to check (WMI)

WMI namespaces:

```
root\subscription
```

Key components:

* Event Filter
* CommandLineEventConsumer
* FilterToConsumerBinding

---

### ğŸ”¸ How SOC checks WMI

PowerShell

```powershell
Get-WmiObject -Namespace root\subscription -Class __EventFilter
Get-WmiObject -Namespace root\subscription -Class CommandLineEventConsumer
```

EDR tools often surface this more clearly than native logs.

---

### ğŸ”¸ Why WMI persistence is dangerous

* No startup entry
* No scheduled task
* No obvious binary
* Triggers silently on system events

Often used by **advanced attackers**.

---

## ğŸ”¹ Logs related to WMI

WMI activity may appear in:

* Security logs (process creation)
* EDR telemetry
* Sysmon (if enabled)

Example indicator:

```
wmiprvse.exe spawning powershell.exe
```

---

## ğŸ”¹ What looks suspicious (SOC signals)

* Tasks created recently without IT change
* SYSTEM tasks pointing to user folders
* Encoded PowerShell in task actions
* Frequent execution intervals
* WMI consumers without known purpose
* Persistence with no startup registry entries

---

## ğŸ”¹ 3rd-party applications SOC uses

* **Sysinternals Autoruns** (Scheduled Tasks + WMI tabs)
* **EDR platforms**
* **OSQuery**
* **SIEM** (Event ID correlation)
* **Sysmon** (if deployed)

---

## ğŸ§  SOC Mindset

If malware:

* Survives reboot
* Has no Run key
* Has no obvious service

â¡ï¸ **Check Scheduled Tasks and WMI**

These two account for a large percentage of **â€œit came back againâ€** incidents.

